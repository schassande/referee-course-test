<ion-header>
    <ion-toolbar>
        <ion-buttons slot="start">
            <ion-button (click)="saveNback()">
                <ion-icon name="arrow-back"></ion-icon>
            </ion-button>
        </ion-buttons>
        <ion-title style="text-align: center;" i18n="@@session-edit.title">Course session</ion-title>
        <ion-buttons slot="end">
            <ion-menu-button autoHide="false" menu="main"></ion-menu-button>
        </ion-buttons>
    </ion-toolbar>
</ion-header>

<ion-content *ngIf="session" (swipe)="onSwipe($event)">
    <ion-fab *ngIf="!readonly" vertical="bottom" horizontal="end" slot="fixed">
        <ion-row>
            <ion-col *ngIf="session.status === 'STARTED'">
                <ion-fab-button routerLink="/session/play/{{session.id}}">
                    <ion-icon name="recording-outline"></ion-icon>
                </ion-fab-button>
            </ion-col>
            <ion-col *ngIf="isTeacher && (session.status === 'REGISTRATION' || session.status === 'STOPPED')">
                <ion-fab-button (click)="start()">
                    <ion-icon name="play-outline"></ion-icon>
                </ion-fab-button>
            </ion-col>
            <ion-col *ngIf="isTeacher && (session.status === 'STARTED')">
                <ion-fab-button (click)="stop()" style='--background:red; font-size: 1.6em; margin-bottom: 10px;'>
                    <ion-icon name="stop-outline"></ion-icon>
                </ion-fab-button>
            </ion-col>
            <ion-col *ngIf="isTeacher && session.status === 'STOPPED'">
                <ion-fab-button (click)="correction()" style='--background:yellow; font-size: 1.6em; margin-bottom: 10px;'>
                    <ion-icon name="checkmark-done-outline"></ion-icon>
                </ion-fab-button>
            </ion-col>
            <ion-col *ngIf="isTeacher && session.status === 'CORRECTION'">
                <ion-fab-button (click)="close()" style='--background:red; font-size: 1.6em; margin-bottom: 10px;'>
                    <ion-icon name="close-outline"></ion-icon>
                </ion-fab-button>
            </ion-col>
            <ion-col *ngIf="isTeacher && (session.status === 'CORRECTION' || session.status === 'CLOSED')">
                <ion-fab-button (click)="computeScores()" style='--background:green; font-size: 1.6em; margin-bottom: 10px;'>
                    <ion-icon name="calculator-outline"></ion-icon>
                </ion-fab-button>
            </ion-col>
            <ion-col *ngIf="isTeacher && (session.status === 'CORRECTION' || session.status === 'CLOSED')">
                <ion-fab-button (click)="exportResults()" style='font-size: 1.6em; margin-bottom: 10px;'>
                    <ion-icon name="download-outline"></ion-icon>
                </ion-fab-button>
            </ion-col>

            <ion-col *ngIf="isTeacher && session.status !== 'CORRECTION' && session.status !== 'CLOSED'">
                <ion-fab-button (click)="addXXX()" style='--background:green; font-size: 1.6em; margin-bottom: 10px;'>
                    <ion-icon name="add"></ion-icon>
                </ion-fab-button>
            </ion-col>
        </ion-row>
    </ion-fab>
    <div *ngIf="loading" style="margin-top: 100px; width: 100%; text-align: center;">
        <ion-spinner></ion-spinner>
    </div>
    <ion-list *ngIf="!loading">
        <ion-item-group style="border-left: 1px solid lightgrey; border-right: 1px solid lightgrey;">
            <ion-item-divider color="light" style="text-align: center; font-size: 1.2em; padding: 10px;">
                <ion-label i18n="@@session-edit.general-info">General information</ion-label>
            </ion-item-divider>
            <ion-item>
                <ion-label i18n="@@session-edit.course">Course:</ion-label>
                <ion-input *ngIf="readonly" type="text" [(ngModel)]="course.name" readonly="true" style="text-align: right;"></ion-input>
                <ion-select *ngIf="!readonly" [(ngModel)]="session.courseId" (change)="onCourseIdChange()">
                    <ion-select-option *ngFor="let course of courses" value="{{course.id}}">{{course.name}}</ion-select-option>
                </ion-select>
            </ion-item>
            <ion-item>
                <ion-label i18n="@@session-edit.code">Code:</ion-label>
                <ion-input type="text" [(ngModel)]="session.keyCode" [readonly]="true" style="text-align: right;"></ion-input>
            </ion-item>
            <ion-item>
                <ion-label i18n="@@session-edit.status">Status:</ion-label>
                <ion-input type="text" [(ngModel)]="session.status" [readonly]="true" style="text-align: right;"></ion-input>
            </ion-item>
            <ion-item>
                <ion-label i18n="@@session-edit.start-date">Start Date:</ion-label>
                <ion-input *ngIf="readonly" type="text" [(ngModel)]="startDate" readonly="true" style="text-align: right;"></ion-input>
                <ion-datetime *ngIf="!readonly" displayFormat="YYYY-MM-DD HH:mm" pickerFormat="YYYY-MM-DD HH:mm" [(ngModel)]="startDate" minuteValues="0,5,10,15,20,25,30,35,40,45,50,55" style="text-align: center;"></ion-datetime>
            </ion-item>
            <ion-item>
                <ion-label i18n="@@session-edit.expire-date">Expire Date:</ion-label>
                <ion-input *ngIf="readonly && session.status !== 'REGISTRATION'" type="text" [(ngModel)]="expireDate" readonly="true" style="text-align: right;"></ion-input>
                <ion-datetime *ngIf="!readonly && session.status !== 'REGISTRATION'" displayFormat="YYYY-MM-DD HH:mm" pickerFormat="YYYY-MM-DD HH:mm" [(ngModel)]="expireDate" minuteValues="0,5,10,15,20,25,30,35,40,45,50,55" style="text-align: center;"></ion-datetime>
            </ion-item>
        </ion-item-group>
        <ion-item-group style="border-left: 1px solid lightgrey; border-right: 1px solid lightgrey;">
            <ion-item-divider color="light" style="text-align: center; font-size: 1.2em; padding: 10px;">
                <ion-label><span i18n="@@session-edit.teachers">Teachers</span> ({{session.teachers.length}})</ion-label>
            </ion-item-divider>
            <ion-item *ngFor="let teacher of session.teachers; let index = index;">
                <ion-label style="border: none;" class="listItemButton">
                    {{teacher.firstName}} {{teacher.lastName}}
                </ion-label>
                <ion-icon *ngIf="!readonly" slot="end" name="trash" (click)="deleteTeacher(teacher, index)"></ion-icon>
            </ion-item>
        </ion-item-group>
        <ion-item-group style="border-left: 1px solid lightgrey; border-right: 1px solid lightgrey;">
            <ion-item-divider color="light" style="text-align: center; font-size: 1.2em; padding: 10px;">
                <ion-label><span i18n="@@session-edit.learners">Learners</span> ({{session.participants.length}})</ion-label>
            </ion-item-divider>
            <ion-item *ngFor="let learner of session.participants; let index = index;">
                <ion-label style="border: none;" class="listItemButton">
                    {{learner.person.firstName}} {{learner.person.lastName}}
                    <span *ngIf="learner.score >= 0" [ngClass]="{'testPass': learner.pass, 'testFail': !learner.pass}">, S:{{learner.score}},R:{{learner.requiredScore}},T:{{course.test.nbQuestion}},({{learner.percent}}%) {{learner.pass ? 'PASS' : 'FAIL'}}</span>
                </ion-label>
                <ion-icon *ngIf="!readonly" slot="end" name="trash" (click)="deleteLearner(learner, index)"></ion-icon>
            </ion-item>
        </ion-item-group>
    </ion-list>
</ion-content>